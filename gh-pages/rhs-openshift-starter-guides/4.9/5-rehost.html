<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5. Rehost (Instructor Only) - 25 minutes :: Moder Application Development - Dev Track</title>
    <link rel="canonical" href="http://localhost:3000/rhs-build-course/index.html/rhs-openshift-starter-guides/4.9/5-rehost.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () { 
      const urlParams = new URLSearchParams(window.location.search);
      const clusterName = urlParams.get('CLUSTER_SUBDOMAIN');
      const projectName = urlParams.get('PROJECT');
      if (clusterName) {
        showCluster( clusterName );
      }
      else {
        showClusterForm();
      }

      if (projectName) {
        showProject( projectName );
      } else {
        showProjectForm();
      }
    } );


    function sliceCluster(clusterName){
      if (clusterName.length > 70) {
          return "..." + clusterName.slice(35);
      } else {
          return clusterName;
      }
    }

    function showCluster( clusterName ) {
      document.getElementById('navbar-form-empty').style.display = "none";
      document.getElementById('navbar-form-filled').style.display = "flex";
      document.getElementById('cluster_subdomain').textContent = sliceCluster(clusterName);
      document.getElementById('clusterfield2').value = clusterName;

    }

    function showClusterForm( clusterName ) {
      document.getElementById('navbar-form-empty').style.display = "flex";
      document.getElementById('navbar-form-filled').style.display = "none";
    }

    function gowithcluster() {
      elClusterInput = document.getElementById('clusterfield');
      elProjectInput = document.getElementById('projectfield2');

      window.location.search = ('&CLUSTER_SUBDOMAIN=' + elClusterInput.value + '&PROJECT=' + elProjectInput.value);
    }

    function showProject( projectName ) {
      document.getElementById('navbar-form-project-empty').style.display = "none";
      document.getElementById('navbar-form-project-filled').style.display = "flex";
      document.getElementById('project').textContent = projectName;
      document.getElementById('projectfield2').value = projectName;
    }

    function showProjectForm( projectName ) {
      document.getElementById('navbar-form-project-empty').style.display = "flex";
      document.getElementById('navbar-form-project-filled').style.display = "none";
    }

    function gowithproject() {
      elProjectInput = document.getElementById('projectfield');
      elClusterInput = document.getElementById('clusterfield2');
      window.location.search = ('&CLUSTER_SUBDOMAIN=' + elClusterInput.value + '&PROJECT=' + elProjectInput.value);
    }

  </script>
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="http://localhost:3000/rhs-build-course/index.html">Moder Application Development - Dev Track</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item" id="navbar-form-empty">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>

          <form action="javascript:void(0);" onsubmit="gowithcluster();">
            <input size="40" id="clusterfield" type="text" placeholder="Enter Cluster Subdomain">
            <input type="hidden" id="projectfield2" name="projectfield2" value="">
          </form>
        </div>

        <div class="navbar-item" id="navbar-form-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
          <span class="navbar-text" id="cluster_subdomain"></span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
        </div>

         <div class="navbar-item" id="navbar-form-project-empty">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i style="color: orange;"
              class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>

          <form action="javascript:void(0);" onsubmit="gowithproject();">
            <input size="40" id="projectfield" type="text" placeholder="Enter Project Name">
            <input type="hidden" id="clusterfield2" name="clusterfield2" value="">
          </form>
        </div>

        <div class="navbar-item" id="navbar-form-project-filled" style="display: none;">
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">|</span>
          <span class="navbar-text" id="project"></span>
          <span class="navbar-text" style="margin-left: 1rem; margin-right: 1rem;">&nbsp;<i onclick="recycle();" style="color: green;" class="fa fa-recycle" aria-hidden="true"></i></span>
        </div>

        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhs-openshift-starter-guides" data-version="4.9">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">OpenShift Starter Guides</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1-introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="2-assessment.html">Assessment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="3-analyze.html">Analyze</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Starter Guides</span>
    <span class="version">4.9</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenShift Starter Guides</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">4.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Starter Guides</a></li>
    <li><a href="5-rehost.html">5. Rehost (Instructor Only) - 25 minutes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/danieloh/Downloads/demo/mad-dev-m1-guides/documentation/modules/ROOT/pages/5-rehost.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">5. Rehost (Instructor Only) - 25 minutes</h1>
<div class="sect1">
<h2 id="_goals_of_this_lab"><a class="anchor" href="#_goals_of_this_lab"></a>Goals of this lab</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you learned how the <em>Globex retails system</em> stands up the application portfolio, the <code>Oracle database</code> is still running on the virtual machine to manage the <em>customers</em> data. After you have refactored the customers application, you will need to deploy the application to the OpenShift cluster along with the modernization path for the containerization.</p>
</div>
<div class="paragraph">
<p>The goal is to migrate the <strong>Oracle virtual machine</strong> from <code>Red Hat Virtualization</code> (RHV) to <code>OpenShift Virtualization</code> using the Migration Toolkit for Virtualization (MTV).</p>
</div>
<div class="paragraph">
<p>The <a href="https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.0/html/installing_and_using_the_migration_toolkit_for_virtualization/about-mtv_mtv" target="_blank" rel="noopener">MTV</a> enables you to migrate virtual machines from VMware vSphere or Red Hat Virtualization to OpenShift Virtualization based on <a href="https://kubevirt.io" target="_blank" rel="noopener">KubeVirt</a>, an add-on to OpenShift Container Platform With OpenShift Virtualization, you can run and manage virtual machine workloads alongside container workloads.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_1_prerequisites"><a class="anchor" href="#_5_1_prerequisites"></a>5.1. Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download the CA Certificate for your RHV environment. You need to do that on your laptop because you will need to drag the file into the Migration Toolkit for the MTV web console later.</p>
</div>
<div class="paragraph">
<p>Set this variable to the RHV hostname from the <strong>shared environment detail page</strong>.</p>
</div>
<div class="paragraph">
<p>Open a new browser to access the following URL. Make sure to replace <code>RHV_HOSTNAME</code> with the hostname from the <strong>shared environment detail page</strong> (e.g., <strong>rhvm.dev.cnv.infra.opentlc.com</strong>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">https://&lt;RHV_HOSTNAME&gt;/ovirt-engine/services/pki-resource?resource=ca-certificate&amp;format=X509-PEM-CA</code></pre>
</div>
</div>
<div class="paragraph">
<p>On most systems this will download a file <code>pki-resource.cer</code> into your <code>Downloads</code> folder. Take a note where this file got downloaded to. You will need it a little bit later.</p>
</div>
<div class="sect2">
<h3 id="_5_2_set_up_virtualization_provider_in_mtv"><a class="anchor" href="#_5_2_set_up_virtualization_provider_in_mtv"></a>5.2. Set up Virtualization Provider in MTV</h3>
<div class="paragraph">
<p>Log into the OpenShift Web Console from the <strong>shared environment detail page</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>admin</code></p>
</li>
<li>
<p>Password: <code>r3dh4t1!</code></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-login.png" alt="ocp-login">
</div>
</div>
<div class="paragraph">
<p>Go to <code>Virtualization</code> on the left menu and click on <code>Virtual Machines</code>. From the <strong>Projects</strong> drop down select the <strong>retail</strong> project. There are no Virtual Machines yet.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ocp-vm.png" alt="ocp-vm">
</div>
</div>
<div class="paragraph">
<p>Click <code>Launch Migration Tool</code> to launch the OpenShift Migration Toolkit for Virtualization.</p>
</div>
<div class="paragraph">
<p>Log in using your <strong>admin</strong> credentials.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Username: <code>admin</code></p>
</li>
<li>
<p>Password: <code>r3dh4t1!</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If this is the first time you are logging in, click on <code>Get started</code> button.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-get-started.png" alt="mtv-get-started">
</div>
</div>
<div class="paragraph">
<p>Click <code>Add provider</code> on the list of <strong>Providers</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-add-provider.png" alt="mtv-add-provider">
</div>
</div>
<div class="paragraph">
<p>Select <strong>Red Hat Virtualization</strong> from the list of providers. Fill in the information in the <strong>shared environment detail page</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Name: <code>rhv</code></p>
</li>
<li>
<p>RHV Manager host name or IP address*: The hostname in the <strong>shared environment detail page</strong> (e.g., <code>rhvm.dev.cnv.infra.opentlc.com</code>)</p>
</li>
<li>
<p>RHV Manager user name: the username in the <strong>shared environment detail page</strong>. (e.g., <code>migrateuser-96trd@internal</code>)</p>
</li>
<li>
<p>RHV Manager password: the password in the <strong>shared environment detail page</strong>. (e.g., <code>ThvA2Ioa6Q4G</code>)</p>
</li>
<li>
<p>CA Certificate: Drop the previously downloaded CA Certificate File</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click <code>Add</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-add-provider-detail.png" alt="mtv-add-provider-detail">
</div>
</div>
<div class="paragraph">
<p>MTV will validate your provider and after a few seconds the status should switch to <strong>Ready</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-add-provider-ready.png" alt="mtv-add-provider-ready">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_3_create_and_execute_migration_plan"><a class="anchor" href="#_5_3_create_and_execute_migration_plan"></a>5.3. Create and execute Migration Plan</h3>
<div class="paragraph">
<p>Go to <code>Migration Plans</code> in the Migration Toolkit for Virtualization console. Click <code>Create Plan</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-create-plan.png" alt="mtv-create-plan">
</div>
</div>
<div class="paragraph">
<p>On the <strong>General settings</strong> page use the following parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plan name: <code>customers-database</code></p>
</li>
<li>
<p>Source provider: <code>rhv</code></p>
</li>
<li>
<p>Target provider: <code>host</code> (the OpenShift cluster you are currently on)</p>
</li>
<li>
<p>Target namespace: <code>retail</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-plan-general.png" alt="mtv-plan-general">
</div>
</div>
<div class="paragraph">
<p>Check <code>All datacenters</code> on the <strong>Filter by VM location</strong>. Click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-plan-vm-loc.png" alt="mtv-plan-vm-loc">
</div>
</div>
<div class="paragraph">
<p>Select the Oracle VM (e.g. <em>oracle-96trd</em>) in the <strong>shared environment detail page</strong> on the <strong>Select VMs</strong> page. Click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-select-vm.png" alt="mtv-select-vm">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Select a network mapping</strong> on the <strong>Network Mapping</strong> page. Then, Select <code>Create a network mapping</code>. Leave the defaults and click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-select-nw.png" alt="mtv-select-nw">
</div>
</div>
<div class="paragraph">
<p>Click on <strong>Select a storage mapping</strong> on the <strong>Storage Mapping</strong> page. Select <code>Create a storage mapping</code>.</p>
</div>
<div class="paragraph">
<p>Change the <strong>Target Storage Class</strong> to <code>gp2-csi</code> and click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-select-storage.png" alt="mtv-select-storage">
</div>
</div>
<div class="paragraph">
<p>Select <code>Cold migration</code> on the <strong>Migration type</strong> page. Click <code>Next</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-select-cold.png" alt="mtv-select-cold">
</div>
</div>
<div class="paragraph">
<p>Click <code>Next</code> on the <strong>Hooks</strong> page.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-select-hook.png" alt="mtv-select-hook">
</div>
</div>
<div class="paragraph">
<p>Click <code>Finish</code> on the <strong>Review</strong> page.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-review.png" alt="mtv-review">
</div>
</div>
<div class="paragraph">
<p>Now your Migration Plan is ready to use. To execute the plan click on <code>Start</code> button in the <strong>customers-database</strong> migration plan.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-plan-ready.png" alt="mtv-plan-ready">
</div>
</div>
<div class="paragraph">
<p>Confirm by clicking the blue <code>Start</code> button in the popup window.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-plan-start.png" alt="mtv-plan-start">
</div>
</div>
<div class="paragraph">
<p>Because you are running a <strong>cold migration</strong> the VM in RHV gets shutdown first.</p>
</div>
<div class="paragraph">
<p>The migration will take about <em>15 - 25</em> minutes after which you will have a running Oracle database VM in your OpenShift cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-plan-complete.png" alt="mtv-plan-complete">
</div>
</div>
<div class="paragraph">
<p>Once the migration succeeds you will find a VM called <code>oracle-xxxxx</code> in your retail namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/mtv-plan-complete-ocp.png" alt="mtv-plan-complete-ocp">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_4_post_migration_tasks"><a class="anchor" href="#_5_4_post_migration_tasks"></a>5.4. Post Migration Tasks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The VM is not yet reachable from other applications on the cluster. You will need to add a label to the VM and then create a service to be able to connect to the database on the VM.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The workshop environment has already created multiple virtual machines separately for the workshop participants. So you will see the unique ID (GUID) for your oracle virtual machine (e.g. <em>oracle-96trd</em>) for the provision Message page.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Set your GUID as an environment value to avoid repeatable replacement in the following command lines.</p>
</div>
<div class="paragraph">
<p>Replace <code>GUID</code> with your GUID from the <strong>shared environment detail page</strong>. (e.g. <em>96trd</em>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">export GUID=YOUR_GUID</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a label to your VM&#8217;s template metadata and make sure to replace <code>${GUID}</code> with your GUID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc patch vm oracle-${GUID} --type=merge --patch="{\"spec\": { \"template\": { \"metadata\": { \"labels\": { \"app\": \"oracle-${GUID}\"}}}}}" -n retail</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the VM for the VM Pod to pick up the new label. Go back to the <code>VirtualMachines</code> menu in the OpenShift Web Console. Click on your VM.</p>
</div>
<div class="paragraph">
<p>From the <strong>Action</strong> drop down select <strong>Restart</strong> then confirm by clicking <strong>Restart</strong> in the pop up dialog.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/restart-vm.png" alt="restart-vm">
</div>
</div>
<div class="paragraph">
<p>When the VM in OpenShift restarted and running again, create service for the database vm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc create service clusterip oracle-${GUID} --tcp=1521:1521 --tcp=2022:22 -n retail</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure your service has the endpoint for the Oracle VM pod as an Endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe svc oracle-${GUID} -n retail</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Sample Output</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-texinfo hljs" data-lang="texinfo">Name:              oracle-96trd
Namespace:         retail
Labels:            app=oracle-96trd
Annotations:       &lt;none&gt;
Selector:          app=oracle-96trd
Type:              ClusterIP
IP Family Policy:  SingleStack
IP Families:       IPv4
IP:                172.30.99.143
IPs:               172.30.99.143
Port:              1521-1521  1521/TCP
TargetPort:        1521/TCP
Endpoints:         10.128.1.156:1521
Port:              2022-22  2022/TCP
TargetPort:        22/TCP
Endpoints:         10.128.1.156:22
Session Affinity:  None
Events:            &lt;none&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>➡️ <a href="./6-deploy-to-kubernetes.adoc">6. Deploy to Kubernetes</a></p>
</div>
<div class="paragraph">
<p>⬅️ <a href="./4-refactor.adoc">4. Refactor</a></p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
